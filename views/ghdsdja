module.exports.internationaltransferPage_post = async (req, res) => {
    try {
          const { id } = req.params;
        const user = await User.findById(id);
        const { amount, transferFrom } = req.body;

        const transferAmount = parseFloat(amount);
        if (isNaN(transferAmount) || transferAmount <= 0) {
            req.flash('error', 'Invalid transfer amount.');
            return res.redirect("/internationaltransfer");
        }

        let selectedBalance = transferFrom === 'btc' ? (user.btcBalance || 0) : user.balance;

        if (transferAmount > selectedBalance) {
            req.flash('error', `Insufficient ${transferFrom === 'btc' ? 'BTC' : 'USD'} balance.`);
            return res.redirect("/internationaltransfer");
        }

        // Store in session
        req.session.transferData = { ...req.body, transferFrom };
        req.session.transferType = 'international';

        // Check if OTP is suspended
        if (user.otpSuspended) {
            req.flash("error", "OTP verification is suspended. Please contact admin for CTO code.");
        } else {
            // Generate and send OTP
            const otpSent = await sendOTP(user);
            if (!otpSent) {
                req.flash("error", "Failed to send OTP. Please try again.");
                return res.redirect("/internationaltransfer");
            }
        }

        // Render OTP verification page
        return res.render('otp-verification', {
            user,
            transferType: 'international',
            messages: req.flash()
        });
    } catch (error) {
       req.flash('error', error.message || 'Transfer failed');
        res.redirect("/internationaltransfer");
    }
};





